/*

 * Copyright 2005 Joe Walker

 *

 * Licensed under the Apache License, Version 2.0 (the "License");

 * you may not use this file except in compliance with the License.

 * You may obtain a copy of the License at

 *

 *     http://www.apache.org/licenses/LICENSE-2.0

 *

 * Unless required by applicable law or agreed to in writing, software

 * distributed under the License is distributed on an "AS IS" BASIS,

 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.

 * See the License for the specific language governing permissions and

 * limitations under the License.

 */



/**

 * Declare a constructor function to which we can add real functions.

 * @constructor

 */



/**

 * Version 1.83 (02/21/06)

 */



function DWREngine(){}DWREngine.setErrorHandler=function(a){DWREngine._errorHandler=a};DWREngine.setWarningHandler=function(a){DWREngine._warningHandler=a};DWREngine.setTimeout=function(a){DWREngine._timeout=a};DWREngine.setPreHook=function(a){DWREngine._preHook=a};DWREngine.setPostHook=function(a){DWREngine._postHook=a};DWREngine.XMLHttpRequest=1;DWREngine.IFrame=2;DWREngine.setMethod=function(a){if(a!=DWREngine.XMLHttpRequest&&a!=DWREngine.IFrame){DWREngine._handleError("Remoting method must be one of DWREngine.XMLHttpRequest or DWREngine.IFrame");return}DWREngine._method=a};DWREngine.setVerb=function(a){if(a!="GET"&&a!="POST"){DWREngine._handleError("Remoting verb must be one of GET or POST");return}DWREngine._verb=a};DWREngine.setOrdered=function(a){DWREngine._ordered=a};DWREngine.setAsync=function(a){DWREngine._async=a};DWREngine.defaultMessageHandler=function(a){if(typeof a=="object"&&a.name=="Error"&&a.description){alert("Error: "+a.description)}else{alert(a)}};DWREngine.beginBatch=function(){if(DWREngine._batch){DWREngine._handleError("Batch already started.");return}DWREngine._batch={};DWREngine._batch.map={};DWREngine._batch.paramCount=0;DWREngine._batch.map.callCount=0;DWREngine._batch.ids=[];DWREngine._batch.preHooks=[];DWREngine._batch.postHooks=[]};DWREngine.endBatch=function(a){var b=DWREngine._batch;if(b==null){DWREngine._handleError("No batch in progress.");return}if(a&&a.preHook)b.preHooks.unshift(a.preHook);if(a&&a.postHook)b.postHooks.push(a.postHook);if(DWREngine._preHook)b.preHooks.unshift(DWREngine._preHook);if(DWREngine._postHook)b.postHooks.push(DWREngine._postHook);if(b.method==null)b.method=DWREngine._method;if(b.verb==null)b.verb=DWREngine._verb;if(b.async==null)b.async=DWREngine._async;if(b.timeout==null)b.timeout=DWREngine._timeout;b.completed=false;DWREngine._batch=null;if(!DWREngine._ordered){DWREngine._sendData(b);DWREngine._batches[DWREngine._batches.length]=b}else{if(DWREngine._batches.length==0){DWREngine._sendData(b);DWREngine._batches[DWREngine._batches.length]=b}else{DWREngine._batchQueue[DWREngine._batchQueue.length]=b}}};DWREngine._errorHandler=DWREngine.defaultMessageHandler;DWREngine._warningHandler=DWREngine.defaultMessageHandler;DWREngine._preHook=null;DWREngine._postHook=null;DWREngine._batches=[];DWREngine._batchQueue=[];DWREngine._handlersMap={};DWREngine._method=DWREngine.XMLHttpRequest;DWREngine._verb="POST";DWREngine._ordered=false;DWREngine._async=true;DWREngine._batch=null;DWREngine._timeout=0;DWREngine._DOMDocument=["Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","Msxml2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"];DWREngine._XMLHTTP=["Msxml2.XMLHTTP.5.0","Msxml2.XMLHTTP.4.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP"];DWREngine._execute=function(a,b,c,d){var e=false;if(DWREngine._batch==null){DWREngine.beginBatch();e=true}var f=[];var g=new WddxSerializer;for(var h=0;h<arguments.length-3;h++){if(typeof arguments[h+3]=="function"){f[h]=arguments[h+3]}else{f[h]=g.serialize(arguments[h+3])}}if(DWREngine._batch.path==null){DWREngine._batch.path=a}else{if(DWREngine._batch.path!=a){DWREngine._handleError("Can't batch requests to multiple DWR Servlets.");return}}var i;var j;var k=f[0];var l=f[f.length-1];if(typeof k=="function"){j={callback:f.shift()};i=f}else if(typeof l=="function"){j={callback:f.pop()};i=f}else if(typeof l=="object"&&l.callback!=null&&typeof l.callback=="function"){j=f.pop();i=f}else if(k==null){if(l==null&&f.length>2){if(DWREngine._warningHandler){DWREngine._warningHandler("Ambiguous nulls at start and end of parameter list. Which is the callback function?")}}j={callback:f.shift()};i=f}else if(l==null){j={callback:f.pop()};i=f}else{if(DWREngine._warningHandler){DWREngine._warningHandler("Missing callback function or metadata object.")}return}var m=Math.floor(Math.random()*10001);var n=(m+"_"+(new Date).getTime()).toString();var o="c"+DWREngine._batch.map.callCount+"-";DWREngine._batch.ids.push(n);if(j.method!=null){DWREngine._batch.method=j.method;delete j.method}if(j.verb!=null){DWREngine._batch.verb=j.verb;delete j.verb}if(j.async!=null){DWREngine._batch.async=j.async;delete j.async}if(j.timeout!=null){DWREngine._batch.timeout=j.timeout;delete j.timeout}if(j.preHook!=null){DWREngine._batch.preHooks.unshift(j.preHook);delete j.preHook}if(j.postHook!=null){DWREngine._batch.postHooks.push(j.postHook);delete j.postHook}if(j.errorHandler==null)j.errorHandler=DWREngine._errorHandler;if(j.warningHandler==null)j.warningHandler=DWREngine._warningHandler;DWREngine._handlersMap[n]=j;DWREngine._batch.map[o+"scriptName"]=b;DWREngine._batch.map[o+"methodName"]=c;DWREngine._batch.map[o+"id"]=n;DWREngine._addSerializeFunctions();for(h=0;h<i.length;h++){DWREngine._serializeAll(DWREngine._batch,[],i[h],o+"param"+h)}DWREngine._removeSerializeFunctions();DWREngine._batch.map.callCount++;if(e){DWREngine.endBatch()}};DWREngine._sendData=function(a){if(a.map.callCount==0)return;for(var b=0;b<a.preHooks.length;b++){a.preHooks[b]()}a.preHooks=null;if(a.timeout&&a.timeout!=0){a.interval=setInterval(function(){clearInterval(a.interval);DWREngine._abortRequest(a)},a.timeout)}var c;if(a.map.callCount==1){c=a.map["c0-scriptName"]+"."+a.map["c0-methodName"]+".dwr"}else{c="Multiple."+a.map.callCount+".dwr"}if(a.method==DWREngine.XMLHttpRequest){if(window.XMLHttpRequest){a.req=new XMLHttpRequest}else if(window.ActiveXObject&&!(navigator.userAgent.indexOf("Mac")>=0&&navigator.userAgent.indexOf("MSIE")>=0)){a.req=DWREngine._newActiveXObject(DWREngine._XMLHTTP)}}var d="method=init&";var e;if(a.req){a.map.xml="true";if(a.async){a.req.onreadystatechange=function(){DWREngine._stateChange(a)}}var f=navigator.userAgent.indexOf("Safari/");if(f>=0){var g=navigator.userAgent.substring(f+7);var h=parseInt(g,10);if(h<400){a.verb=="GET"}}if(a.verb=="GET"){a.map.callCount=""+a.map.callCount;for(e in a.map){var i=encodeURIComponent(e);var j=encodeURIComponent(a.map[e]);if(j==""){if(DWREngine._warningHandler){DWREngine._warningHandler("Found empty qval for qkey="+i)}}d+=i+"="+j+"&"}d=d.substring(0,d.length-1);try{a.req.open("GET",a.path+"?"+d,a.async);a.req.setRequestHeader("Referer",location.href);a.req.send(null);if(!a.async){DWREngine._stateChange(a)}}catch(k){DWREngine._handleMetaDataError(null,k)}}else{for(e in a.map){if(typeof a.map[e]!="function"){d+=e+"="+a.map[e]+"&"}}try{a.req.open("POST",a.path,a.async);a.req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");a.req.setRequestHeader("Referer",location.href);a.req.send(d);if(!a.async){DWREngine._stateChange(a)}}catch(k){DWREngine._handleMetaDataError(null,k)}}}else{a.map.xml="false";var l="dwr-if-"+a.map["c0-id"];a.div=document.createElement("div");a.div.innerHTML="<iframe frameborder='0' width='0' height='0' id='"+l+"' name='"+l+"'></iframe>";document.body.appendChild(a.div);a.iframe=document.getElementById(l);a.iframe.setAttribute("style","width:0px; height:0px; border:0px;");if(a.verb=="GET"){for(e in a.map){if(typeof a.map[e]!="function"){d+=encodeURIComponent(e)+"="+encodeURIComponent(a.map[e])+"&"}}d=d.substring(0,d.length-1);a.iframe.setAttribute("src",a.path+"?"+d);document.body.appendChild(a.iframe)}else{a.form=document.createElement("form");a.form.setAttribute("id","dwr-form");a.form.setAttribute("action",a.path);a.form.setAttribute("target",l);a.form.target=l;a.form.setAttribute("method","post");for(e in a.map){var m=document.createElement("input");m.setAttribute("type","hidden");m.setAttribute("name",e);m.setAttribute("value",a.map[e]);a.form.appendChild(m)}document.body.appendChild(a.form);a.form.submit()}}};DWREngine._stateChange=function(batch){if(!batch.completed&&batch.req.readyState==4){try{var reply=batch.req.responseText.replace(/<meta name="coldfusionmxedition"[^>]*>/gi,"");var status=batch.req.status;if(reply==null||reply==""){DWREngine._handleMetaDataError(null,"No data received from server");return}if(reply.search("DWREngine._handle")==-1){DWREngine._handleMetaDataError(null,"Invalid reply from server");return}if(status!=200){if(reply==null)reply="Unknown error occured";DWREngine._handleMetaDataError(null,reply);return}eval(reply);DWREngine._clearUp(batch)}catch(ex){if(ex==null)ex="Unknown error occured";DWREngine._handleMetaDataError(null,ex)}finally{if(DWREngine._batchQueue.length!=0){var sendbatch=DWREngine._batchQueue.shift();DWREngine._sendData(sendbatch);DWREngine._batches[DWREngine._batches.length]=sendbatch}}}};DWREngine._handleResponse=function(a,b){var c=DWREngine._handlersMap[a];DWREngine._handlersMap[a]=null;if(c){try{if(c.callback)c.callback(b)}catch(d){DWREngine._handleMetaDataError(c,d)}}if(DWREngine._method==DWREngine.IFrame){var e=DWREngine._batches[DWREngine._batches.length-1];if(e.map["c"+(e.map.callCount-1)+"-id"]==a){DWREngine._clearUp(e)}}};DWREngine._handleServerError=function(a,b){var c=DWREngine._handlersMap[a];DWREngine._handlersMap[a]=null;if(b.message){DWREngine._handleMetaDataError(c,b.message,b)}else{DWREngine._handleMetaDataError(c,b)}};DWREngine._abortRequest=function(a){if(a&&a.metadata!=null&&!a.completed){DWREngine._clearUp(a);if(a.req)a.req.abort();var b;var c;for(var d=0;d<a.ids.length;d++){c=a.ids[d];b=DWREngine._handlersMap[c];DWREngine._handleMetaDataError(b,"Timeout")}}};DWREngine._clearUp=function(a){if(a.completed){alert("double complete");return}if(a.div)a.div.parentNode.removeChild(a.div);if(a.iframe)a.iframe.parentNode.removeChild(a.iframe);if(a.form)a.form.parentNode.removeChild(a.form);if(a.req)delete a.req;for(var b=0;b<a.postHooks.length;b++){a.postHooks[b]()}a.postHooks=null;for(var b=0;b<DWREngine._batches.length;b++){if(DWREngine._batches[b]==a){DWREngine._batches.splice(b,1);break}}a.completed=true};DWREngine._handleError=function(a,b){if(DWREngine._errorHandler){DWREngine._errorHandler(a,b)}};DWREngine._handleMetaDataError=function(a,b,c){if(a&&typeof a.errorHandler=="function"){a.errorHandler(b,c)}else{DWREngine._handleError(b,c)}};DWREngine._addSerializeFunctions=function(){Object.prototype.dwrSerialize=DWREngine._serializeObject;Array.prototype.dwrSerialize=DWREngine._serializeArray;Boolean.prototype.dwrSerialize=DWREngine._serializeBoolean;Number.prototype.dwrSerialize=DWREngine._serializeNumber;String.prototype.dwrSerialize=DWREngine._serializeString;Date.prototype.dwrSerialize=DWREngine._serializeDate};DWREngine._removeSerializeFunctions=function(){delete Object.prototype.dwrSerialize;delete Array.prototype.dwrSerialize;delete Boolean.prototype.dwrSerialize;delete Number.prototype.dwrSerialize;delete String.prototype.dwrSerialize;delete Date.prototype.dwrSerialize};DWREngine._serializeAll=function(a,b,c,d){if(c==null){a.map[d]="null:null";return}switch(typeof c){case"boolean":a.map[d]="boolean:"+c;break;case"number":a.map[d]="number:"+c;break;case"string":a.map[d]="string:"+encodeURIComponent(c);break;case"object":if(c.dwrSerialize){a.map[d]=c.dwrSerialize(a,b,c,d)}else if(c.nodeName){a.map[d]=DWREngine._serializeXml(a,b,c,d)}else{if(DWREngine._warningHandler){DWREngine._warningHandler("Object without dwrSerialize: "+typeof c+", attempting default converter.")}a.map[d]="default:"+c}break;case"function":break;default:if(DWREngine._warningHandler){DWREngine._warningHandler("Unexpected type: "+typeof c+", attempting default converter.")}a.map[d]="default:"+c;break}};DWREngine._lookup=function(a,b,c){var d;for(var e=0;e<a.length;e++){if(a[e].data==b){d=a[e];break}}if(d){return"reference:"+d.name}a.push({data:b,name:c});return null};DWREngine._serializeObject=function(a,b,c,d){var e=DWREngine._lookup(b,this,d);if(e)return e;if(c.nodeName){return DWREngine._serializeXml(a,b,c,d)}var f="Object:{";var g;for(g in this){if(g!="dwrSerialize"){a.paramCount++;var h="c"+DWREngine._batch.map.callCount+"-e"+a.paramCount;DWREngine._serializeAll(a,b,this[g],h);f+=encodeURIComponent(g);f+=":reference:";f+=h;f+=", "}}if(f.substring(f.length-2)==", "){f=f.substring(0,f.length-2)}f+="}";return f};DWREngine._serializeXml=function(a,b,c,d){var e=DWREngine._lookup(b,this,d);if(e){return e}var f;if(window.XMLSerializer){var g=new XMLSerializer;f=g.serializeToString(c)}else{f=c.toXml}return"XML:"+encodeURIComponent(f)};DWREngine._serializeArray=function(a,b,c,d){var e=DWREngine._lookup(b,this,d);if(e)return e;var f="Array:[";for(var g=0;g<this.length;g++){if(g!=0){f+=","}a.paramCount++;var h="c"+DWREngine._batch.map.callCount+"-e"+a.paramCount;DWREngine._serializeAll(a,b,this[g],h);f+="reference:";f+=h}f+="]";return f};DWREngine._serializeBoolean=function(a,b,c,d){return"Boolean:"+this};DWREngine._serializeNumber=function(a,b,c,d){return"Number:"+this};DWREngine._serializeString=function(a,b,c,d){return"String:"+encodeURIComponent(this)};DWREngine._serializeDate=function(a,b,c,d){return"Date:"+this.getTime()};DWREngine._unserializeDocument=function(a){var b;if(window.DOMParser){var c=new DOMParser;b=c.parseFromString(a,"text/xml");if(!b.documentElement||b.documentElement.tagName=="parsererror"){var d=b.documentElement.firstChild.data;d+="\n"+b.documentElement.firstChild.nextSibling.firstChild.data;throw d}return b}else if(window.ActiveXObject){b=DWREngine._newActiveXObject(DWREngine._DOMDocument);b.loadXML(a);return b}else{var e=document.createElement("div");e.innerHTML=a;return e}};DWREngine._newActiveXObject=function(a){var b;for(var c=0;c<a.length;c++){try{b=new ActiveXObject(a[c]);break}catch(d){}}return b};if(typeof window.encodeURIComponent==="undefined"){DWREngine._utf8=function(a){a=""+a;var b;var c;var d="";var e=0;while(e<a.length){b=a.charCodeAt(e++);if(b>=56320&&b<57344)continue;if(b>=55296&&b<56320){if(e>=a.length)continue;c=a.charCodeAt(e++);if(c<56320||b>=56832)continue;b=(b-55296<<10)+(c-56320)+65536}if(b<128){d+=String.fromCharCode(b)}else if(b<2048){d+=String.fromCharCode(192+(b>>6),128+(b&63))}else if(b<65536){d+=String.fromCharCode(224+(b>>12),128+(b>>6&63),128+(b&63))}else{d+=String.fromCharCode(240+(b>>18),128+(b>>12&63),128+(b>>6&63),128+(b&63))}}return d};DWREngine._hexchars="0123456789ABCDEF";DWREngine._toHex=function(a){return DWREngine._hexchars.charAt(a>>4)+DWREngine._hexchars.charAt(a&15)};DWREngine._okURIchars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_-";window.encodeURIComponent=function(a){a=DWREngine._utf8(a);var b;var c="";for(var d=0;d<a.length;d++){if(DWREngine._okURIchars.indexOf(a.charAt(d))==-1){c+="%"+DWREngine._toHex(a.charCodeAt(d))}else{c+=a.charAt(d)}}return c}}if(typeof Array.prototype.splice==="undefined"){Array.prototype.splice=function(a,b){if(arguments.length==0){return a}if(typeof a!="number"){a=0}if(a<0){a=Math.max(0,this.length+a)}if(a>this.length){if(arguments.length>2){a=this.length}else{return[]}}if(arguments.length<2){b=this.length-a}b=typeof b=="number"?Math.max(0,b):0;removeArray=this.slice(a,a+b);endArray=this.slice(a+b);this.length=a;for(var c=2;c<arguments.length;c++){this[this.length]=arguments[c]}for(c=0;c<endArray.length;c++){this[this.length]=endArray[c]}return removeArray}}if(typeof Array.prototype.shift==="undefined"){Array.prototype.shift=function(a){var b=this[0];for(var c=1;c<this.length;++c){this[c-1]=this[c]}this.length--;return b}}if(typeof Array.prototype.unshift==="undefined"){Array.prototype.unshift=function(){var a=unshift.arguments.length;for(var b=this.length-1;b>=0;--b){this[b+a]=this[b]}for(b=0;b<a;++b){this[b]=unshift.arguments[b]}}}if(typeof Array.prototype.push==="undefined"){Array.prototype.push=function(){var a=this.length;for(var b=0;b<push.arguments.length;++b){this[a]=push.arguments[b];a++}}}if(typeof Array.prototype.pop==="undefined"){Array.prototype.pop=function(){var a=this[this.length-1];this.length--;return a}}